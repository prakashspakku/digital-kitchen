# 1) Allow scripts for *this* PowerShell session only
- name: Allow PowerShell scripts in this session
  shell: powershell
  run: |
    Set-ExecutionPolicy -Scope Process -ExecutionPolicy RemoteSigned -Force
    Write-Host "ExecutionPolicy (effective): $(Get-ExecutionPolicy)"

# 2) Configure kubeconfig using PowerShell-native commands
- name: Configure kubeconfig (PowerShell)
  shell: powershell
  env:
    KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}
  run: |
    # mkdir -p equivalent in PowerShell
    $null = New-Item -ItemType Directory -Path "$HOME\.kube" -Force

    # If a base64 kubeconfig secret is provided, decode to file
    if ($env:KUBECONFIG_B64) {
      [IO.File]::WriteAllBytes(
        "$HOME\.kube\config",
        [Convert]::FromBase64String($env:KUBECONFIG_B64)
      )
    } else {
      Write-Host "KUBECONFIG_B64 empty - using existing $HOME\.kube\config if present"
    }

# 3) Sanity check connectivity
- name: Check cluster
  shell: powershell
  run: |
    kubectl version --client
    kubectl cluster-info
