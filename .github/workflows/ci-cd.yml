name: Kitchen Pipeline (CI/CD)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ vars.DOCKERHUB_USERNAME }}/dish

concurrency:
  group: digital-kitchen-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install (noop) & run tests
        run: |
          npm ci || npm install
          npm test

  build-and-push:
    name: Build & Push Image
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push (latest + sha)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    name: Deploy to Kubernetes
    needs: build-and-push
    # Use self-hosted so this job can reach your local Docker Desktop cluster
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        uses: Azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Configure kubeconfig
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}
        run: |
          mkdir -p $HOME/.kube
          if [ -n "$KUBECONFIG_B64" ]; then
            echo "$KUBECONFIG_B64" | base64 --decode > $HOME/.kube/config
          fi
          kubectl version --client
          kubectl cluster-info

      - name: Apply base manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/service.yaml -n digital-kitchen
          kubectl apply -f k8s/deployment.yaml -n digital-kitchen
          kubectl apply -f k8s/pdb.yaml -n digital-kitchen || true
          kubectl apply -f k8s/hpa.yaml -n digital-kitchen || true

      - name: Update image to commit SHA and rollout
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          kubectl -n digital-kitchen set image deployment/digital-kitchen \
            digital-kitchen-container=${IMAGE_NAME}:${GITHUB_SHA}
          kubectl -n digital-kitchen rollout status deployment/digital-kitchen --timeout=120s
